<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>K8SCL</title>
  <meta name="generator" content="VuePress 1.9.5">

  <!-- CDN 出错 -->
  <script src="/assets/js/xmind-embed-viewer.js"></script>
  <script type="text/javascript" src="/assets/js/markdown-it/8.4.2/markdown-it.js"></script>
  <script type="text/javascript" src="/assets/js/markdown-it-drawio-viewer.js"></script>
  <script type="text/javascript" src="/assets/js/jquery/3.4.0/jquery.js"></script>


  <link rel="icon" href="/favicon.ico">
  <meta name="description" content="K8s 源码学习、二次开发、自定义组件开发">
    <meta name="keywords" content="技术文档,kubernetes,k8s,go,golang">
    <meta name="theme-color" content="#11a8cd">
  
  <link rel="preload" href="/assets/css/0.styles.f6c502f2.css" as="style"><link rel="preload" href="/assets/js/app.bb52296d.js" as="script"><link rel="preload" href="/assets/js/2.10f4d805.js" as="script"><link rel="preload" href="/assets/js/3.d91ac3a8.js" as="script"><link rel="preload" href="/assets/js/19.03331e5a.js" as="script"><link rel="prefetch" href="/assets/js/10.e6bdce21.js"><link rel="prefetch" href="/assets/js/11.969be0b0.js"><link rel="prefetch" href="/assets/js/12.645254c7.js"><link rel="prefetch" href="/assets/js/13.e33ab6ca.js"><link rel="prefetch" href="/assets/js/14.f2fe010f.js"><link rel="prefetch" href="/assets/js/15.945e1edf.js"><link rel="prefetch" href="/assets/js/16.acdb0e08.js"><link rel="prefetch" href="/assets/js/17.ef286641.js"><link rel="prefetch" href="/assets/js/18.5e5fe87b.js"><link rel="prefetch" href="/assets/js/20.be43cd27.js"><link rel="prefetch" href="/assets/js/21.c493a2d9.js"><link rel="prefetch" href="/assets/js/22.a7e25e0a.js"><link rel="prefetch" href="/assets/js/23.8f1887ae.js"><link rel="prefetch" href="/assets/js/24.7c28767c.js"><link rel="prefetch" href="/assets/js/4.d266ff45.js"><link rel="prefetch" href="/assets/js/5.69a191cc.js"><link rel="prefetch" href="/assets/js/6.2b730f2b.js"><link rel="prefetch" href="/assets/js/7.cfe31641.js"><link rel="prefetch" href="/assets/js/8.57f670b9.js"><link rel="prefetch" href="/assets/js/9.160c1b6d.js">
  <link rel="stylesheet" href="/assets/css/0.styles.f6c502f2.css">

</head>

<body class="theme-mode-light">
  <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="" class="logo"> <!----></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/pages/b99bda/" class="nav-link">Kubernetes 源码开发之旅</a></div> <a href="https://github.com/brook-w/blogs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/logo.png"> <div class="blogger-info"><h3>brook-w</h3> <span>K8s 源码学习、二次开发、自定义组件开发</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/pages/b99bda/" class="nav-link">Kubernetes 源码开发之旅</a></div> <a href="https://github.com/brook-w/blogs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/pages/b99bda/" class="sidebar-link">（一）环境搭建</a></li><li><a href="/pages/21e760/" class="sidebar-link">（二）编译运行并调试源码</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>（三）API Server 源码刨析</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/pages/33da11/" aria-current="page" class="active sidebar-link">（四）Aggregated API Server 的实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/33da11/#目的" class="sidebar-link">目的</a></li><li class="sidebar-sub-header level2"><a href="/pages/33da11/#扩展目标" class="sidebar-link">扩展目标</a></li><li class="sidebar-sub-header level2"><a href="/pages/33da11/#aggregated-api-server-的制作步骤" class="sidebar-link">Aggregated API Server 的制作步骤</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/33da11/#_1-设计编码-api-object" class="sidebar-link">1. 设计编码 API Object</a></li><li class="sidebar-sub-header level3"><a href="/pages/33da11/#_2-代码生成" class="sidebar-link">2. 代码生成</a></li><li class="sidebar-sub-header level4"><a href="/pages/33da11/#deepcopy-方法" class="sidebar-link">DeepCopy 方法</a></li><li class="sidebar-sub-header level4"><a href="/pages/33da11/#conversion-方法" class="sidebar-link">Conversion  方法</a></li><li class="sidebar-sub-header level4"><a href="/pages/33da11/#defaulter-方法" class="sidebar-link">Defaulter  方法</a></li><li class="sidebar-sub-header level4"><a href="/pages/33da11/#clientset-相关的包和方法" class="sidebar-link">Clientset 相关的包和方法</a></li><li class="sidebar-sub-header level4"><a href="/pages/33da11/#informer-lister-openapi" class="sidebar-link">Informer，Lister，OpenAPI</a></li><li class="sidebar-sub-header level3"><a href="/pages/33da11/#_3-注册-api-object" class="sidebar-link">3. 注册 API Object</a></li><li class="sidebar-sub-header level3"><a href="/pages/33da11/#_4-registry-ao存储和-rest" class="sidebar-link">4. Registry - AO存储和 REST</a></li><li class="sidebar-sub-header level4"><a href="/pages/33da11/#_5-添加-admission" class="sidebar-link">5. 添加 Admission</a></li><li class="sidebar-sub-header level4"><a href="/pages/33da11/#_5-制作-web-server" class="sidebar-link">5.  制作 Web Server</a></li><li class="sidebar-sub-header level4"><a href="/pages/33da11/#_7-部署至集群" class="sidebar-link">7. 部署至集群</a></li></ul></li></ul></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-deb3a48a><div class="articleInfo" data-v-deb3a48a><ul class="breadcrumbs" data-v-deb3a48a><li data-v-deb3a48a><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-deb3a48a></a></li> <li data-v-deb3a48a><a href="/k8scl/#Kubernetes 源码开发之旅" data-v-deb3a48a>Kubernetes 源码开发之旅</a></li></ul> <div class="info" data-v-deb3a48a><div title="作者" class="author iconfont icon-touxiang" data-v-deb3a48a><a href="https://github.com/k8scl" target="_blank" title="作者" class="beLink" data-v-deb3a48a>brook-w</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-deb3a48a><a href="javascript:;" data-v-deb3a48a>2023-02-10</a></div> <!----> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">（四）Aggregated API Server 的实现<!----></h1>  <div class="theme-vdoing-content content__default"><h2 id="目的"><a href="#目的" class="header-anchor">#</a> 目的</h2> <p>在开发过程中通常需要自定义一些目的来控制或提供一些额外的功能，为了应对大量这样的需求，Kuberbetes 可以自定义一些 API Server，这里我们就实现一个简单的 <u>Aggregated API Server</u></p> <h2 id="扩展目标"><a href="#扩展目标" class="header-anchor">#</a> 扩展目标</h2> <!----> <div class="custom-block tip"><p class="custom-block-title">提示</p> <blockquote><p>TIP1:
在决定使用 Aggregated API Server 去实现功能的时候，请认真考虑 CRD 是否已经可以满足你的需求，这样会大大节省时间和精力，虽然它缺失一些灵活性，但是足以满足大多是的应用需求</p></blockquote> <blockquote><p>TIP2:
真实项目优先使用 <a href="https://github.com/kubernetes-sigs/apiserver-builder-alpha" target="_blank" rel="noopener noreferrer">apiserver-builder<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 它会为你生成你想要的一切，并且是遵循社区编码规范和要求的</p></blockquote></div> <h2 id="aggregated-api-server-的制作步骤"><a href="#aggregated-api-server-的制作步骤" class="header-anchor">#</a> Aggregated API Server 的制作步骤</h2> <ul><li><ol><li>设计编码 API Object</li></ol> <blockquote><p>设计出支持 API Object，并编码实现他们</p></blockquote></li> <li><ol start="2"><li>代码生成</li></ol> <blockquote><p>利用代码生成器，为 API Object 生成配套代码</p></blockquote></li> <li><ol start="3"><li>注册 API Object</li></ol> <blockquote><p>编写把 API Object 注册进 Schema 的方法</p></blockquote></li> <li><ol start="4"><li>Registry - AO存储和 REST</li></ol> <blockquote><p>编码实现对 API Object 实例的 CRUD。并最终处理 Restful 请求</p></blockquote></li> <li><ol start="5"><li>添加 Admission</li></ol> <blockquote><p>利用 Admission 机制对针对 API Object 的请求进行修正和校验</p></blockquote></li> <li><ol start="6"><li>创建 Web Server</li></ol> <blockquote><p>制作 Web Server 可以响应 HTTP Restful 请求</p></blockquote></li> <li><ol start="7"><li>部署并测试</li></ol> <blockquote><p>把 Aggregated API Server 部署到集群，并测试其功能</p></blockquote></li></ul> <h3 id="_1-设计编码-api-object"><a href="#_1-设计编码-api-object" class="header-anchor">#</a> 1. 设计编码 API Object</h3> <p><strong>设计重点：</strong></p> <ul><li><ol><li><strong>设计好AO：</strong> 提前构想出需要支持的 API Object 属性，文档化便于后续实现；注意有内部版本和外部版本，他们结构可以不同</li></ol></li> <li><ol start="2"><li><strong>创建工程：</strong> 工程最好创建在 GOPATH 下面的 src 目录中；内部工程目录参考 kubernetes 项目</li></ol></li> <li><ol start="3"><li><strong>内外部版本：</strong> 如果有多个外部版本，那么内部版本即有可能和外部版本有不同的结构；外部版本需要有字段 tag，用于 go 结构和 json 格式的相互转换</li></ol></li></ul> <p><img alt="image" data-src="https://cdn.staticaly.com/gh/brook-w/image-hosting@master/k8s/k8scl/image.37shn73oxc20.webp" loading="lazy" class="lazy"></p> <p><strong>外部版本（对接使用者）</strong></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> v1alpha

<span class="token keyword">import</span> metav1 <span class="token string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span>

<span class="token comment">// +genclient</span>
<span class="token comment">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object</span>
<span class="token keyword">type</span> JenkinsService <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	metav1<span class="token punctuation">.</span>TypeMeta   <span class="token string">`json:&quot;,inline&quot;`</span>
	metav1<span class="token punctuation">.</span>ObjectMeta <span class="token string">`json:&quot;metadata,omitempty&quot; protobuf:&quot;bytes,1,name=metadata&quot;`</span>

	Spec   JenkinsServiceSpec   <span class="token string">`json:&quot;spec,omitempty&quot; protobuf:&quot;bytes,2,opt,name=spec&quot;`</span>
	Status JenkinsServiceStatus <span class="token string">`json:&quot;status,omitempty&quot; protobuf:&quot;bytes,3,opt,name=status&quot;`</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> JenkinsServiceSpec <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	InstanceAmount <span class="token builtin">int</span> <span class="token string">`json:&quot;instanceamount,omitempty&quot; protobuf:&quot;int32,1,opt,name=instanceamount&quot;`</span>
	InstanceCpu    <span class="token builtin">int</span> <span class="token string">`json:&quot;instancecpu,omitempty&quot; protobuf:&quot;int32,2,opt,name=instancecpu&quot;`</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> JenkinsServiceStatus <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	ApprovalStatus <span class="token builtin">string</span>                  <span class="token string">`json:&quot;approvalstatus&quot; protobuf:&quot;bytes,1,name=approvalstatus&quot;`</span>
	Instances      <span class="token punctuation">[</span><span class="token punctuation">]</span>JenkinsServerInstance <span class="token string">`json:&quot;instances&quot; protobuf:&quot;bytes,2,rep,name=instances&quot;`</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> JenkinsServerInstance <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Cpu     <span class="token builtin">int</span>  <span class="token string">`json:&quot;cpu&quot; protobuf:&quot;int32,1,name=cpu&quot;`</span>
	Running <span class="token builtin">bool</span> <span class="token string">`json:&quot;running&quot; protobuf:&quot;bool,2,name=running&quot;`</span>
<span class="token punctuation">}</span>

<span class="token comment">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object</span>
<span class="token keyword">type</span> JenkinsServiceList <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	metav1<span class="token punctuation">.</span>TypeMeta <span class="token string">`json:&quot;,inline&quot;`</span>
	metav1<span class="token punctuation">.</span>ListMeta <span class="token string">`json:&quot;metadata,omitempty&quot; protobuf:&quot;bytes,1,opt,name=metadata&quot;`</span>

	Items <span class="token punctuation">[</span><span class="token punctuation">]</span>JenkinsService <span class="token string">`json:&quot;items&quot; protobuf:&quot;bytes,2,rep,name=items&quot;`</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="_2-代码生成"><a href="#_2-代码生成" class="header-anchor">#</a> 2. 代码生成</h3> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>针对 API Object 的内外部版本，代码生成机制会生成：</p> <ul><li>default、deepcopy 和版本间 conversion 的代码；</li> <li>clientset - 作为 “客户端” 访问我们的 aggregated api server 的 api；</li> <li>informer - 作为 controller 等监控  aggregated api server 中资源的 API；</li> <li>lister - 从 server 读取资源的基础 API；</li> <li>同时也会生成支持 openapi 的 go 代码</li></ul></div> <p><strong>关键步骤：</strong></p> <ul><li><strong>1. 加代码注解：</strong> k8s 的代码生成工具 <code>code-gen</code> 根据代码上的注解工作，我们需要加上 <code>global</code>、<code>local</code>注解来指导生成过程</li> <li><strong>2.  客制化的逻辑：</strong> 对于复杂的 API Object，工具生成的 conversion 方法可能不能满足要求，我们可以注入自己的逻辑；Defaulter 的生成也需要我们写 <code>SetDefaults_&lt;Type&gt;</code> 方法</li> <li><strong>3.  编写脚本：</strong> 引入 <code>code-gen</code> 包并通过 <code>go mod vendor</code> 复制该包到工程目录 vendor 目录下，注意所使用的版本；通过编写生成的脚本来避免使用大量命令行操作</li> <li><strong>4.  检查生成内容：</strong> 执行脚本，代码生成完毕后需要查看一下 IDE 的提示和错误</li></ul> <h4 id="deepcopy-方法"><a href="#deepcopy-方法" class="header-anchor">#</a> DeepCopy 方法</h4> <ul><li><strong>DeepCopy()：</strong> 给结构体添加该方法，使得从一个结构体的实例 copy 出一个新实例</li> <li><strong>DeepCopyInto()：</strong> 给结构体添加该方法，把一个结构体的实例 copy 到另一个实例中</li> <li><strong>DeepCopyObject()：</strong> 给结构体添加该方法，把一个结构体的实例 copy 到另一个新实例，该新实例的类型时 <code>runtime.Object</code></li></ul> <div class="language-go extra-class"><div class="highlight-lines"><br><div class="highlighted"> </div><br><br><br><br><div class="highlighted"> </div><br><br></div><pre class="language-go"><code><span class="token comment">// cicd-apiserver/pkg/apis/cicd/v1alpha/doc.go</span>
<span class="token comment">// +k8s:deepcopy-gen=package</span>
<span class="token keyword">package</span> v1alpha

<span class="token comment">// cicd-apiserver/pkg/apis/cicd/v1alpha/types.go</span>
<span class="token comment">// +genclient</span>
<span class="token comment">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object</span>
<span class="token keyword">type</span> JenkinsService <span class="token keyword">struct</span> <span class="token punctuation">{</span>
</code></pre></div><h4 id="conversion-方法"><a href="#conversion-方法" class="header-anchor">#</a> Conversion  方法</h4> <ul><li><strong>Convert_&lt;内部版本AO&gt;<em>TO</em>&lt;外部版本AO&gt;()：</strong> 给结构体添加该方法，使得从一个结构体的内部版本实例到一个外部版本实例</li> <li><strong>Convert_&lt;外部版本AO&gt;<em>TO</em>&lt;内部版本AO&gt;()：</strong> 反向转换的方法</li></ul> <div class="custom-block tip"><p class="custom-block-title">如何转换为特定转换生成代码</p> <p>在运行代码生成脚本前，自己按照命名规则，在正确的包下写一个同名的转换方法，代码生成器会直接复用你生成的代码</p></div> <div class="language-go extra-class"><div class="highlight-lines"><br><div class="highlighted"> </div><br><br></div><pre class="language-go"><code><span class="token comment">// cicd-apiserver/pkg/apis/cicd/v1alpha/doc.go</span>
<span class="token comment">// +k8s:conversion-gen=cicd-apiserver/pkg/apis/cicd</span>
<span class="token keyword">package</span> v1alpha
</code></pre></div><h4 id="defaulter-方法"><a href="#defaulter-方法" class="header-anchor">#</a> Defaulter  方法</h4> <ul><li><strong>SetObjectDefaults_&lt;AO&gt;：</strong> 在这个方法内，AO 实例各个字段的默认值会逐一设置，<u>但只考虑如下字段：他们的类型具有与之相对应的 <code>SetDefaults_&lt;Type&gt;</code> 方法，这里的 Type 时该字段的类型</u></li></ul> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p><code>SetDefaults_&lt;Type&gt;</code> 时我们自己手动编写的</p></div> <div class="language-go extra-class"><div class="highlight-lines"><br><div class="highlighted"> </div><br><br></div><pre class="language-go"><code><span class="token comment">// cicd-apiserver/pkg/apis/cicd/v1alpha/doc.go</span>
<span class="token comment">// +k8s:defaulter-gen=TypeMeta</span>
<span class="token keyword">package</span> v1alpha
</code></pre></div><h4 id="clientset-相关的包和方法"><a href="#clientset-相关的包和方法" class="header-anchor">#</a> Clientset 相关的包和方法</h4> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// 这个注解生成相应的 Clientset 代码</span>
<span class="token comment">// +genclient</span>
</code></pre></div><h4 id="informer-lister-openapi"><a href="#informer-lister-openapi" class="header-anchor">#</a> Informer，Lister，OpenAPI</h4> <p>这些代码也会被 <code>code-gen</code> 生成</p> <p><strong>code-gen 脚本：</strong></p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token shebang important">#!/usr/bin/env bash</span>

<span class="token builtin class-name">set</span> <span class="token parameter variable">-o</span> errexit
<span class="token builtin class-name">set</span> <span class="token parameter variable">-o</span> nounset
<span class="token builtin class-name">set</span> <span class="token parameter variable">-o</span> pipefail

<span class="token assign-left variable">SCRIPT_ROOT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">dirname</span> $<span class="token punctuation">{</span><span class="token environment constant">BASH_SOURCE</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token variable">)</span></span>/<span class="token punctuation">..</span>
<span class="token assign-left variable">CODEGEN_PKG</span><span class="token operator">=</span><span class="token variable">${CODEGEN_PKG<span class="token operator">:-</span>$(cd ${SCRIPT_ROOT}</span><span class="token punctuation">;</span> <span class="token function">ls</span> <span class="token parameter variable">-d</span> <span class="token parameter variable">-1</span> ./vendor/k8s.io/code-generator <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>/dev/null <span class="token operator">||</span> <span class="token builtin class-name">echo</span> <span class="token punctuation">..</span>/code-generator<span class="token punctuation">)</span><span class="token punctuation">}</span>

<span class="token function">bash</span> <span class="token variable">${CODEGEN_PKG}</span>/generate-internal-groups.sh all <span class="token punctuation">\</span>
  cicd-apiserver/pkg/generated cicd-apiserver/pkg/apis cicd-apiserver/pkg/apis <span class="token punctuation">\</span>
  <span class="token string">&quot;cicd:v1alpha&quot;</span> <span class="token punctuation">\</span>
  --go-header-file <span class="token variable">${SCRIPT_ROOT}</span>/hack/boilerplate.go.txt
</code></pre></div><p><a href="*https://github.com/JackyZhangFuDan/cicd-apiserver/tree/phase-1/*">生成代码脚本仓库分支</a></p> <h3 id="_3-注册-api-object"><a href="#_3-注册-api-object" class="header-anchor">#</a> 3. 注册 API Object</h3> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>利用 Builder 设计模式，向 Scheme 中注册我们的 API Object</p></div> <p><strong>内部 register.go</strong></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> cicd

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;k8s.io/apimachinery/pkg/runtime&quot;</span>
	<span class="token string">&quot;k8s.io/apimachinery/pkg/runtime/schema&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> GroupName <span class="token operator">=</span> <span class="token string">&quot;autobusi.group.cicd&quot;</span>

<span class="token keyword">var</span> SchemeGroupVersion <span class="token operator">=</span> schema<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">{</span>Group<span class="token punctuation">:</span> GroupName<span class="token punctuation">,</span> Version<span class="token punctuation">:</span> runtime<span class="token punctuation">.</span>APIVersionInternal<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Kind</span><span class="token punctuation">(</span>kind <span class="token builtin">string</span><span class="token punctuation">)</span> schema<span class="token punctuation">.</span>GroupKind <span class="token punctuation">{</span>
	<span class="token keyword">return</span> SchemeGroupVersion<span class="token punctuation">.</span><span class="token function">WithKind</span><span class="token punctuation">(</span>kind<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GroupKind</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 需要的，按名字找到resource实例</span>
<span class="token keyword">func</span> <span class="token function">Resource</span><span class="token punctuation">(</span>resource <span class="token builtin">string</span><span class="token punctuation">)</span> schema<span class="token punctuation">.</span>GroupResource <span class="token punctuation">{</span>
	<span class="token keyword">return</span> SchemeGroupVersion<span class="token punctuation">.</span><span class="token function">WithResource</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GroupResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 下面的两个var是必须的，因为在生成的代码里直接用了这个包下的这两个变量</span>
<span class="token keyword">var</span> <span class="token punctuation">(</span>
	SchemeBuilder <span class="token operator">=</span> runtime<span class="token punctuation">.</span><span class="token function">NewSchemeBuilder</span><span class="token punctuation">(</span>addKnownTypes<span class="token punctuation">)</span>
	AddToScheme   <span class="token operator">=</span> SchemeBuilder<span class="token punctuation">.</span>AddToScheme
<span class="token punctuation">)</span>

<span class="token comment">// 被SchemeBuilder调用，从而把自己知道的Object（Type）注册到scheme中</span>
<span class="token keyword">func</span> <span class="token function">addKnownTypes</span><span class="token punctuation">(</span>scheme <span class="token operator">*</span>runtime<span class="token punctuation">.</span>Scheme<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	scheme<span class="token punctuation">.</span><span class="token function">AddKnownTypes</span><span class="token punctuation">(</span>
		SchemeGroupVersion<span class="token punctuation">,</span>
		<span class="token operator">&amp;</span>JenkinsService<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token operator">&amp;</span>JenkinsServiceList<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>外部 register.go</strong></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> v1alpha

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	metav1 <span class="token string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span>
	<span class="token string">&quot;k8s.io/apimachinery/pkg/runtime&quot;</span>
	<span class="token string">&quot;k8s.io/apimachinery/pkg/runtime/schema&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> GroupName <span class="token operator">=</span> <span class="token string">&quot;autobusi.group.cicd&quot;</span>

<span class="token keyword">var</span> SchemeGroupVersion <span class="token operator">=</span> schema<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">{</span>Group<span class="token punctuation">:</span> GroupName<span class="token punctuation">,</span> Version<span class="token punctuation">:</span> <span class="token string">&quot;v1alpha&quot;</span><span class="token punctuation">}</span>

<span class="token comment">// 需要的，按名字找到resource实例</span>
<span class="token keyword">func</span> <span class="token function">Resource</span><span class="token punctuation">(</span>resource <span class="token builtin">string</span><span class="token punctuation">)</span> schema<span class="token punctuation">.</span>GroupResource <span class="token punctuation">{</span>
	<span class="token keyword">return</span> SchemeGroupVersion<span class="token punctuation">.</span><span class="token function">WithResource</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GroupResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// var的定义和internal version的register中基本类似，</span>
<span class="token comment">// 只是创建Builder时多了一个中间产物local scheme builder，local builder会在包括生成代码的init中去使用</span>
<span class="token keyword">var</span> <span class="token punctuation">(</span>
	SchemeBuilder      runtime<span class="token punctuation">.</span>SchemeBuilder
	localSchemeBuilder <span class="token operator">=</span> <span class="token operator">&amp;</span>SchemeBuilder
	AddToScheme        <span class="token operator">=</span> localSchemeBuilder<span class="token punctuation">.</span>AddToScheme
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//这里去注册本version的类型，以及它们向internal version的转换函数</span>
	localSchemeBuilder<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>addKnownTypes<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 被SchemeBuilder调用，从而把自己知道的Object（Type）注册到scheme中</span>
<span class="token keyword">func</span> <span class="token function">addKnownTypes</span><span class="token punctuation">(</span>scheme <span class="token operator">*</span>runtime<span class="token punctuation">.</span>Scheme<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	scheme<span class="token punctuation">.</span><span class="token function">AddKnownTypes</span><span class="token punctuation">(</span>
		SchemeGroupVersion<span class="token punctuation">,</span>
		<span class="token operator">&amp;</span>JenkinsService<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token operator">&amp;</span>JenkinsServiceList<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">)</span>
	metav1<span class="token punctuation">.</span><span class="token function">AddToGroupVersion</span><span class="token punctuation">(</span>scheme<span class="token punctuation">,</span> SchemeGroupVersion<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

</code></pre></div><p><strong>install/install.go</strong></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> install

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;cicd-apiserver/pkg/apis/cicd&quot;</span>
	<span class="token string">&quot;cicd-apiserver/pkg/apis/cicd/v1alpha&quot;</span>

	<span class="token string">&quot;k8s.io/apimachinery/pkg/runtime&quot;</span>
	util <span class="token string">&quot;k8s.io/apimachinery/pkg/util/runtime&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">Install</span><span class="token punctuation">(</span>scheme <span class="token operator">*</span>runtime<span class="token punctuation">.</span>Scheme<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	util<span class="token punctuation">.</span><span class="token function">Must</span><span class="token punctuation">(</span>cicd<span class="token punctuation">.</span><span class="token function">AddToScheme</span><span class="token punctuation">(</span>scheme<span class="token punctuation">)</span><span class="token punctuation">)</span>
	util<span class="token punctuation">.</span><span class="token function">Must</span><span class="token punctuation">(</span>v1alpha<span class="token punctuation">.</span><span class="token function">AddToScheme</span><span class="token punctuation">(</span>scheme<span class="token punctuation">)</span><span class="token punctuation">)</span>
	util<span class="token punctuation">.</span><span class="token function">Must</span><span class="token punctuation">(</span>scheme<span class="token punctuation">.</span><span class="token function">SetVersionPriority</span><span class="token punctuation">(</span>v1alpha<span class="token punctuation">.</span>SchemeGroupVersion<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="_4-registry-ao存储和-rest"><a href="#_4-registry-ao存储和-rest" class="header-anchor">#</a> 4. Registry - AO存储和 REST</h3> <p>创建 API Object 实例如何存储到 ETCD 中？为响应 Restful 请求，怎么从 ETCD 中存取 API Object？</p> <p><strong>关键步骤：</strong></p> <ul><li>**Strategy：**针对 Create、Update、Delete 等操作我们可以编写必要的代码区客制化 apiserver 的标准实现，系统在合适的时间去掉用他们</li> <li><strong>Store：</strong> Kuberbetes 包为 Aggregated API Server 提供了绝大部分处理 ETCD 数据存取的工作，主要的载体就是 Store 结构体。我们需要借用 StandardStore 来制作自己的 Store</li></ul> <p><img alt="image" data-src="https://cdn.staticaly.com/gh/brook-w/image-hosting@master/k8s/k8scl/image.6d2o78dk7a80.webp" loading="lazy" class="lazy"></p> <h4 id="_5-添加-admission"><a href="#_5-添加-admission" class="header-anchor">#</a> 5. 添加 Admission</h4> <p>Admission 给我们提供了一个扩展点，对 RESTful 请求进行修正和校验</p> <p><strong>关键步骤：</strong></p> <ul><li><strong>Admission Plugin：</strong> 首先我们要制作一个 Admission Plugin。这只要实现一个简单的 Admission.Interface 就可以了</li> <li><strong>注入 Informer：</strong>（option），但是在 Admission 过程中极有可能需要读取 API Object 信息，这时候就需要 Informer，我们这一步注入 Informer 到 Plugin 中供其使用</li> <li><strong>Mutation 接口：</strong> Admission 的第一阶段是 mutation，我们可以对接受到的 Restful 请求做一些修改，例如注入 sidecar。Plugin 需要实现 admission.MutationInterface 来参与这个阶段</li> <li>**Validation 接口： ** Admission 第二阶段是 Validation，让我们的 Plugin 实现 admission.ValidationInterface 来参与到这个阶段</li></ul> <p><strong>上面主要的 Interface：</strong></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// vendor/k8s.io/apiserver/pkg/admission/interfaces.go</span>

<span class="token comment">// Interface is an abstract, pluggable interface for Admission Control decisions.</span>
<span class="token keyword">type</span> Interface <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token comment">// Handles returns true if this admission controller can handle the given operation</span>
	<span class="token comment">// where operation can be one of CREATE, UPDATE, DELETE, or CONNECT</span>
	<span class="token function">Handles</span><span class="token punctuation">(</span>operation Operation<span class="token punctuation">)</span> <span class="token builtin">bool</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> MutationInterface <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	Interface

	<span class="token comment">// Admit makes an admission decision based on the request attributes.</span>
	<span class="token comment">// Context is used only for timeout/deadline/cancellation and tracing information.</span>
	<span class="token function">Admit</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> a Attributes<span class="token punctuation">,</span> o ObjectInterfaces<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// ValidationInterface is an abstract, pluggable interface for Admission Control decisions.</span>
<span class="token keyword">type</span> ValidationInterface <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	Interface

	<span class="token comment">// Validate makes an admission decision based on the request attributes.  It is NOT allowed to mutate</span>
	<span class="token comment">// Context is used only for timeout/deadline/cancellation and tracing information.</span>
	<span class="token function">Validate</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> a Attributes<span class="token punctuation">,</span> o ObjectInterfaces<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Operation is the type of resource operation being checked for admission control</span>
<span class="token keyword">type</span> Operation <span class="token builtin">string</span>

<span class="token comment">// Operation constants</span>
<span class="token keyword">const</span> <span class="token punctuation">(</span>
	Create  Operation <span class="token operator">=</span> <span class="token string">&quot;CREATE&quot;</span>
	Update  Operation <span class="token operator">=</span> <span class="token string">&quot;UPDATE&quot;</span>
	Delete  Operation <span class="token operator">=</span> <span class="token string">&quot;DELETE&quot;</span>
	Connect Operation <span class="token operator">=</span> <span class="token string">&quot;CONNECT&quot;</span>
<span class="token punctuation">)</span>
</code></pre></div><!----> <p><strong>具体的代码实现：</strong></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// cicd-apiserver</span>
<span class="token comment">// pkg/admission/plugin/jsplugins.go</span>
<span class="token keyword">package</span> plugin

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;cicd-apiserver/pkg/apis/cicd&quot;</span>
	<span class="token string">&quot;context&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;io&quot;</span>

	informers <span class="token string">&quot;cicd-apiserver/pkg/generated/informers/internalversion&quot;</span>
	listers <span class="token string">&quot;cicd-apiserver/pkg/generated/listers/cicd/internalversion&quot;</span>

	<span class="token string">&quot;k8s.io/apiserver/pkg/admission&quot;</span>

	<span class="token string">&quot;k8s.io/apimachinery/pkg/labels&quot;</span>
<span class="token punctuation">)</span>

<span class="token comment">// plugin必须实现admission.Interface接口，而内嵌的admission.Handler结构体就实现了</span>
<span class="token keyword">type</span> JenkinsServicePlugin <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token operator">*</span>admission<span class="token punctuation">.</span>Handler
	jsLister listers<span class="token punctuation">.</span>JenkinsServiceLister
<span class="token punctuation">}</span>

<span class="token comment">// 把这个plugin注册进api server体系中的方法，会在server启动的代码中调用</span>
<span class="token comment">// plugin 参数是server的plugins集合，需要把我们的放进去</span>
<span class="token keyword">func</span> <span class="token function">Register</span><span class="token punctuation">(</span>plugin <span class="token operator">*</span>admission<span class="token punctuation">.</span>Plugins<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	plugin<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token string">&quot;JenkinsService&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>config io<span class="token punctuation">.</span>Reader<span class="token punctuation">)</span> <span class="token punctuation">(</span>admission<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 创建plugin结构体实例的方法</span>
<span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>JenkinsServicePlugin<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>JenkinsServicePlugin<span class="token punctuation">{</span>
		Handler<span class="token punctuation">:</span> admission<span class="token punctuation">.</span><span class="token function">NewHandler</span><span class="token punctuation">(</span>admission<span class="token punctuation">.</span>Create<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// 有了validate方法就实现了admission.ValidationInterface，从而在validating阶段被调用</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>jsp <span class="token operator">*</span>JenkinsServicePlugin<span class="token punctuation">)</span> <span class="token function">Validate</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> a admission<span class="token punctuation">.</span>Attributes<span class="token punctuation">,</span> <span class="token boolean">_</span> admission<span class="token punctuation">.</span>ObjectInterfaces<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> a<span class="token punctuation">.</span><span class="token function">GetKind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GroupKind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> cicd<span class="token punctuation">.</span><span class="token function">Kind</span><span class="token punctuation">(</span><span class="token string">&quot;JenkinsService&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//所有object的valid都会进来，所以我们要验一下是不是该关心的</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token operator">!</span>jsp<span class="token punctuation">.</span><span class="token function">WaitForReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 例如informer还没有把远程信息sync到本地</span>
		<span class="token keyword">return</span> admission<span class="token punctuation">.</span><span class="token function">NewForbidden</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;the plugin isn't ready for handling request&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 下面就可以进行我们期望的校验了</span>
	<span class="token comment">// 区别于registry部分strategy中的valid strategy，此处的校验更多是多实体之间的关联正确性，而不是单个jenkins service内容的正确</span>
	<span class="token comment">// 例如，我们规定整个系统中只能存在10 个JenkinsService对象，多了不行，就可以在这里做检查</span>
	existedJenkinsServices<span class="token punctuation">,</span> err <span class="token operator">:=</span> jsp<span class="token punctuation">.</span>jsLister<span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>labels<span class="token punctuation">.</span><span class="token function">Everything</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> admission<span class="token punctuation">.</span><span class="token function">NewForbidden</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;the plugin encounter internal error during retrieve jenkins service objects from api server&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>existedJenkinsServices<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">10</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> admission<span class="token punctuation">.</span><span class="token function">NewForbidden</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;too many service instances exist, %d exist but max is 10&quot;</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>existedJenkinsServices<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token boolean">nil</span>

<span class="token punctuation">}</span>

<span class="token comment">// 有了这个方法，plugin就实现了WantsCicdInformerFactory接口，可以获取到cicd informer了</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>jsp <span class="token operator">*</span>JenkinsServicePlugin<span class="token punctuation">)</span> <span class="token function">SetInformerFactory</span><span class="token punctuation">(</span>f informers<span class="token punctuation">.</span>SharedInformerFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	jsp<span class="token punctuation">.</span>jsLister <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">Autobusi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">InternalVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">JenkinsServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lister</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	jsp<span class="token punctuation">.</span><span class="token function">SetReadyFunc</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">Autobusi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">InternalVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">JenkinsServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Informer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>HasSynced<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// cicd-apiserver</span>
<span class="token comment">// pkg/admission/informerinjector.go</span>

<span class="token keyword">package</span> admission

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	informers <span class="token string">&quot;cicd-apiserver/pkg/generated/informers/internalversion&quot;</span>

	<span class="token string">&quot;k8s.io/apiserver/pkg/admission&quot;</span>
<span class="token punctuation">)</span>

<span class="token comment">// 需要admission plugin去实现这个接口，从而保证可以接收informerfactory；</span>
<span class="token keyword">type</span> WantsCicdInformerFactory <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">SetInformerFactory</span><span class="token punctuation">(</span>informers<span class="token punctuation">.</span>SharedInformerFactory<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> cicdInformerPluginInitializer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	informers informers<span class="token punctuation">.</span>SharedInformerFactory
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i cicdInformerPluginInitializer<span class="token punctuation">)</span> <span class="token function">Initialize</span><span class="token punctuation">(</span>plugin admission<span class="token punctuation">.</span>Interface<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> wants<span class="token punctuation">,</span> ok <span class="token operator">:=</span> plugin<span class="token punctuation">.</span><span class="token punctuation">(</span>WantsCicdInformerFactory<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span> <span class="token comment">//如果目标plugin通过实现接口，声明需要cicd informer，那么我们就给它</span>
		wants<span class="token punctuation">.</span><span class="token function">SetInformerFactory</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>informers<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// server启动时在config阶段被调用，从而把informer交给plugin</span>
<span class="token keyword">func</span> <span class="token function">NewCicdInformerPluginInitializer</span><span class="token punctuation">(</span>informers informers<span class="token punctuation">.</span>SharedInformerFactory<span class="token punctuation">)</span> cicdInformerPluginInitializer <span class="token punctuation">{</span>
	<span class="token keyword">return</span> cicdInformerPluginInitializer<span class="token punctuation">{</span>
		informers<span class="token punctuation">:</span> informers<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_5-制作-web-server"><a href="#_5-制作-web-server" class="header-anchor">#</a> 5.  制作 Web Server</h4> <p>一个 Aggregated API Server 是一个可以响应 Restful 请求的 Web Server，在 k8s 的 apiserver 子工程也为我们提供了全部的 web server 实现，我们只需要加入客制化的配置项，然后接受用户命令行输入，转化为 server 可消费的结构，启动 server 就可以了</p> <p>在 server 启动过程中，还涉及到触发 API Object 向 Scheme 的注册，初始化 Admission Plugin 相关的工作</p> <p><strong>主要步骤：</strong></p> <ul><li><ol><li><strong>编写 Server 实例：</strong> 把 apiserver 包一层，插入自己的客制化逻辑；提供启动 Server 的方法</li></ol></li> <li><ol start="2"><li><strong>对接命令行：</strong> 基于 cobra 框架开发命令行对接程序，接受用户启动 Server 时在命令行的输入</li></ol></li> <li><ol start="3"><li><strong>触发初始化：</strong> 在把 Option 传递给 Server 实例的过程中，触发 API Object 的注册，Informer 的初始化，Admission 的创建和注册</li></ol></li></ul> <!----> <p>关键代码</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// cicd-apiserver</span>
<span class="token comment">// cmd/server/server.go</span>

<span class="token keyword">package</span> server

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;net&quot;</span>

	<span class="token string">&quot;github.com/spf13/cobra&quot;</span>
	utilerrors <span class="token string">&quot;k8s.io/apimachinery/pkg/util/errors&quot;</span>
	<span class="token string">&quot;k8s.io/apiserver/pkg/admission&quot;</span>
	genericserver <span class="token string">&quot;k8s.io/apiserver/pkg/server&quot;</span>
	genericoptions <span class="token string">&quot;k8s.io/apiserver/pkg/server/options&quot;</span>

	myadmission <span class="token string">&quot;cicd-apiserver/pkg/admission&quot;</span>
	<span class="token string">&quot;cicd-apiserver/pkg/admission/plugin&quot;</span>
	<span class="token string">&quot;cicd-apiserver/pkg/apis/cicd/v1alpha&quot;</span>
	<span class="token string">&quot;cicd-apiserver/pkg/apiserver&quot;</span>
	clientset <span class="token string">&quot;cicd-apiserver/pkg/generated/clientset/internalversion&quot;</span>
	informers <span class="token string">&quot;cicd-apiserver/pkg/generated/informers/internalversion&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> etcdPathPrefix <span class="token operator">=</span> <span class="token string">&quot;/registry/cicd-apiserver.autobusi.com&quot;</span>

<span class="token comment">// 以下环节制作option，option是server启动参数，由它进一步制作config，再然后由config制造server</span>
<span class="token keyword">type</span> ServerOptions <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	RecommendedOptions    <span class="token operator">*</span>genericoptions<span class="token punctuation">.</span>RecommendedOptions
	SharedInformerFactory informers<span class="token punctuation">.</span>SharedInformerFactory
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewServerOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>ServerOptions <span class="token punctuation">{</span>
	o <span class="token operator">:=</span> <span class="token operator">&amp;</span>ServerOptions<span class="token punctuation">{</span>
		RecommendedOptions<span class="token punctuation">:</span> genericoptions<span class="token punctuation">.</span><span class="token function">NewRecommendedOptions</span><span class="token punctuation">(</span>
			etcdPathPrefix<span class="token punctuation">,</span>
			apiserver<span class="token punctuation">.</span>Codecs<span class="token punctuation">.</span><span class="token function">LegacyCodec</span><span class="token punctuation">(</span>v1alpha<span class="token punctuation">.</span>SchemeGroupVersion<span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> o
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>ServerOptions<span class="token punctuation">)</span> <span class="token function">Validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	errors <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">error</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	errors <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errors<span class="token punctuation">,</span> o<span class="token punctuation">.</span>RecommendedOptions<span class="token punctuation">.</span><span class="token function">Validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>
	<span class="token comment">//把errors数组合并成单独error</span>
	<span class="token keyword">return</span> utilerrors<span class="token punctuation">.</span><span class="token function">NewAggregate</span><span class="token punctuation">(</span>errors<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>ServerOptions<span class="token punctuation">)</span> <span class="token function">Complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token comment">//把我们的admission plugin加进去</span>
	plugin<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>RecommendedOptions<span class="token punctuation">.</span>Admission<span class="token punctuation">.</span>Plugins<span class="token punctuation">)</span>
	<span class="token comment">//plugin 的相互顺序很重要，最好不要破坏已有顺序，直接加在尾部</span>
	o<span class="token punctuation">.</span>RecommendedOptions<span class="token punctuation">.</span>Admission<span class="token punctuation">.</span>RecommendedPluginOrder <span class="token operator">=</span>
		<span class="token function">append</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>RecommendedOptions<span class="token punctuation">.</span>Admission<span class="token punctuation">.</span>RecommendedPluginOrder<span class="token punctuation">,</span> <span class="token string">&quot;JenkinsService&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>ServerOptions<span class="token punctuation">)</span> <span class="token function">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>apiserver<span class="token punctuation">.</span>Config<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//申请系统分派证书</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> o<span class="token punctuation">.</span>RecommendedOptions<span class="token punctuation">.</span>SecureServing<span class="token punctuation">.</span><span class="token function">MaybeDefaultWithSelfSignedCerts</span><span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>net<span class="token punctuation">.</span>IP<span class="token punctuation">{</span>net<span class="token punctuation">.</span><span class="token function">ParseIP</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;error creating self-signed certificates: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//把我们admission用的informer做出来，放入admission初始化器。informer的初始化在post start hook中进行</span>
	o<span class="token punctuation">.</span>RecommendedOptions<span class="token punctuation">.</span>ExtraAdmissionInitializers <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>cfg <span class="token operator">*</span>genericserver<span class="token punctuation">.</span>RecommendedConfig<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>admission<span class="token punctuation">.</span>PluginInitializer<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		client<span class="token punctuation">,</span> err <span class="token operator">:=</span> clientset<span class="token punctuation">.</span><span class="token function">NewForConfig</span><span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>LoopbackClientConfig<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
		<span class="token punctuation">}</span>
		informerFactory <span class="token operator">:=</span> informers<span class="token punctuation">.</span><span class="token function">NewSharedInformerFactory</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>LoopbackClientConfig<span class="token punctuation">.</span>Timeout<span class="token punctuation">)</span>
		o<span class="token punctuation">.</span>SharedInformerFactory <span class="token operator">=</span> informerFactory
		<span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>admission<span class="token punctuation">.</span>PluginInitializer<span class="token punctuation">{</span>myadmission<span class="token punctuation">.</span><span class="token function">NewCicdInformerPluginInitializer</span><span class="token punctuation">(</span>informerFactory<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//做config，用于返回</span>
	standardConfig <span class="token operator">:=</span> genericserver<span class="token punctuation">.</span><span class="token function">NewRecommendedConfig</span><span class="token punctuation">(</span>apiserver<span class="token punctuation">.</span>Codecs<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> o<span class="token punctuation">.</span>RecommendedOptions<span class="token punctuation">.</span><span class="token function">ApplyTo</span><span class="token punctuation">(</span>standardConfig<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	myConfig <span class="token operator">:=</span> <span class="token operator">&amp;</span>apiserver<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
		GenericConfig<span class="token punctuation">:</span> standardConfig<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> myConfig<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// 把server做出来并跑起来</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>ServerOptions<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span>stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">,</span> err <span class="token operator">:=</span> o<span class="token punctuation">.</span><span class="token function">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>

	s<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>

	s<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">.</span><span class="token function">AddPostStartHook</span><span class="token punctuation">(</span><span class="token string">&quot;start-cicd-apiserver-informers&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>context genericserver<span class="token punctuation">.</span>PostStartHookContext<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>SharedInformerFactory<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>StopCh<span class="token punctuation">)</span>
		o<span class="token punctuation">.</span>SharedInformerFactory<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>StopCh<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> s<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">.</span><span class="token function">PrepareRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//以下环节制作cobra command，它可以启动server</span>
<span class="token keyword">func</span> <span class="token function">NewCommandStartServer</span><span class="token punctuation">(</span>defaultOptions <span class="token operator">*</span>ServerOptions<span class="token punctuation">,</span> stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command <span class="token punctuation">{</span>
	options <span class="token operator">:=</span> <span class="token operator">*</span>defaultOptions
	cmd <span class="token operator">:=</span> <span class="token operator">&amp;</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">{</span>
		Short<span class="token punctuation">:</span> <span class="token string">&quot;my cicd api server&quot;</span><span class="token punctuation">,</span>
		Long<span class="token punctuation">:</span>  <span class="token string">&quot;my api server for demostration purpose&quot;</span><span class="token punctuation">,</span>
		RunE<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> err <span class="token operator">:=</span> options<span class="token punctuation">.</span><span class="token function">Complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> err <span class="token operator">:=</span> options<span class="token punctuation">.</span><span class="token function">Validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> err <span class="token operator">:=</span> options<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	flags <span class="token operator">:=</span> cmd<span class="token punctuation">.</span><span class="token function">Flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	options<span class="token punctuation">.</span>RecommendedOptions<span class="token punctuation">.</span><span class="token function">AddFlags</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span>
	<span class="token keyword">return</span> cmd
<span class="token punctuation">}</span>
</code></pre></div><div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// cicd-apiserver</span>
<span class="token comment">// pkg/apiserver/apiserver.go</span>

<span class="token keyword">package</span> apiserver

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;cicd-apiserver/pkg/apis/cicd&quot;</span>
	cicdregistry <span class="token string">&quot;cicd-apiserver/pkg/registry&quot;</span>
	jsstorage <span class="token string">&quot;cicd-apiserver/pkg/registry/cicd/jenkinsservice&quot;</span>

	metav1 <span class="token string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span>
	<span class="token string">&quot;k8s.io/apimachinery/pkg/runtime&quot;</span>
	<span class="token string">&quot;k8s.io/apimachinery/pkg/runtime/schema&quot;</span>
	<span class="token string">&quot;k8s.io/apimachinery/pkg/runtime/serializer&quot;</span>
	<span class="token string">&quot;k8s.io/apimachinery/pkg/version&quot;</span>
	<span class="token string">&quot;k8s.io/apiserver/pkg/registry/rest&quot;</span>
	genericapiserver <span class="token string">&quot;k8s.io/apiserver/pkg/server&quot;</span>

	<span class="token string">&quot;cicd-apiserver/pkg/apis/cicd/install&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	Scheme <span class="token operator">=</span> runtime<span class="token punctuation">.</span><span class="token function">NewScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	Codecs <span class="token operator">=</span> serializer<span class="token punctuation">.</span><span class="token function">NewCodecFactory</span><span class="token punctuation">(</span>Scheme<span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token comment">// 如下方法需要更新至相应phase，开始漏掉了</span>
<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	install<span class="token punctuation">.</span><span class="token function">Install</span><span class="token punctuation">(</span>Scheme<span class="token punctuation">)</span>
	metav1<span class="token punctuation">.</span><span class="token function">AddToGroupVersion</span><span class="token punctuation">(</span>Scheme<span class="token punctuation">,</span> schema<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">{</span>Version<span class="token punctuation">:</span> <span class="token string">&quot;v1&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	unversioned <span class="token operator">:=</span> schema<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">{</span>Group<span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> Version<span class="token punctuation">:</span> <span class="token string">&quot;v1&quot;</span><span class="token punctuation">}</span>
	Scheme<span class="token punctuation">.</span><span class="token function">AddUnversionedTypes</span><span class="token punctuation">(</span>
		unversioned<span class="token punctuation">,</span>
		<span class="token operator">&amp;</span>metav1<span class="token punctuation">.</span>Status<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token operator">&amp;</span>metav1<span class="token punctuation">.</span>APIVersions<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token operator">&amp;</span>metav1<span class="token punctuation">.</span>APIGroupList<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token operator">&amp;</span>metav1<span class="token punctuation">.</span>APIGroup<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token operator">&amp;</span>metav1<span class="token punctuation">.</span>APIResourceList<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//如下环节制作Server的Config</span>
<span class="token keyword">type</span> Config <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	GenericConfig <span class="token operator">*</span>genericapiserver<span class="token punctuation">.</span>RecommendedConfig
	<span class="token comment">// ExtraConfig   ExtraConfig // 如果有自己需要的config的话，可以扩展field</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> completedConfig <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	GenericConfig genericapiserver<span class="token punctuation">.</span>CompletedConfig
<span class="token punctuation">}</span>

<span class="token comment">//完善后的config</span>
<span class="token keyword">type</span> CompletedConfig <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token operator">*</span>completedConfig
<span class="token punctuation">}</span>

<span class="token keyword">type</span> CicdServer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	GenericAPIServer <span class="token operator">*</span>genericapiserver<span class="token punctuation">.</span>GenericAPIServer
<span class="token punctuation">}</span>

<span class="token comment">//完善初始的config</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>cfg <span class="token operator">*</span>Config<span class="token punctuation">)</span> <span class="token function">Complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> CompletedConfig <span class="token punctuation">{</span>
	cconfig <span class="token operator">:=</span> completedConfig<span class="token punctuation">{</span>
		cfg<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span><span class="token function">Complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	cconfig<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>Version <span class="token operator">=</span> <span class="token operator">&amp;</span>version<span class="token punctuation">.</span>Info<span class="token punctuation">{</span>
		Major<span class="token punctuation">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
		Minor<span class="token punctuation">:</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> CompletedConfig<span class="token punctuation">{</span><span class="token operator">&amp;</span>cconfig<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//有了这个方法，完善后的config就可以制作server的instance了</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>ccfg completedConfig<span class="token punctuation">)</span> <span class="token function">NewServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>CicdServer<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	genericServer<span class="token punctuation">,</span> err <span class="token operator">:=</span> ccfg<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;cicd-apiserver&quot;</span><span class="token punctuation">,</span> genericapiserver<span class="token punctuation">.</span><span class="token function">NewEmptyDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>

	server <span class="token operator">:=</span> <span class="token operator">&amp;</span>CicdServer<span class="token punctuation">{</span>
		GenericAPIServer<span class="token punctuation">:</span> genericServer<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//重点是把我们各个版本的api object都注入到server中去，开始</span>
	apiGroupInfo <span class="token operator">:=</span> genericapiserver<span class="token punctuation">.</span><span class="token function">NewDefaultAPIGroupInfo</span><span class="token punctuation">(</span>
		cicd<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span>
		Scheme<span class="token punctuation">,</span>
		metav1<span class="token punctuation">.</span>ParameterCodec<span class="token punctuation">,</span>
		Codecs<span class="token punctuation">,</span>
	<span class="token punctuation">)</span>
	v1alphastorage <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>rest<span class="token punctuation">.</span>Storage<span class="token punctuation">{</span><span class="token punctuation">}</span>
	v1alphastorage<span class="token punctuation">[</span><span class="token string">&quot;jenkinsservices&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> cicdregistry<span class="token punctuation">.</span><span class="token function">RESTWithErrorHandler</span><span class="token punctuation">(</span>jsstorage<span class="token punctuation">.</span><span class="token function">NewREST</span><span class="token punctuation">(</span>Scheme<span class="token punctuation">,</span> ccfg<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>RESTOptionsGetter<span class="token punctuation">)</span><span class="token punctuation">)</span>
	apiGroupInfo<span class="token punctuation">.</span>VersionedResourcesStorageMap<span class="token punctuation">[</span><span class="token string">&quot;v1alpha&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> v1alphastorage

	<span class="token keyword">if</span> err <span class="token operator">:=</span> server<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">.</span><span class="token function">InstallAPIGroup</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>apiGroupInfo<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> server<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// main.go</span>

<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;flag&quot;</span>

	genericserver <span class="token string">&quot;k8s.io/apiserver/pkg/server&quot;</span>
	<span class="token string">&quot;k8s.io/component-base/logs&quot;</span>
	<span class="token string">&quot;k8s.io/klog/v2&quot;</span>

	<span class="token string">&quot;cicd-apiserver/cmd/server&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 把cobra cmd做出来</span>
	stopCh <span class="token operator">:=</span> genericserver<span class="token punctuation">.</span><span class="token function">SetupSignalHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	options <span class="token operator">:=</span> server<span class="token punctuation">.</span><span class="token function">NewServerOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	cmd <span class="token operator">:=</span> server<span class="token punctuation">.</span><span class="token function">NewCommandStartServer</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> stopCh<span class="token punctuation">)</span>
	cmd<span class="token punctuation">.</span><span class="token function">Flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddGoFlagSet</span><span class="token punctuation">(</span>flag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">)</span>
	<span class="token comment">// 初始化以下log， 需要在parse flag之后</span>
	logs<span class="token punctuation">.</span><span class="token function">InitLogs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> logs<span class="token punctuation">.</span><span class="token function">FlushLogs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 启动</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> cmd<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		klog<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>到了这里 Web Server 就制作完成了</p> <h4 id="_7-部署至集群"><a href="#_7-部署至集群" class="header-anchor">#</a> 7. 部署至集群</h4> <p>我们需要把这个 Aggregated API Server 引入集群，让 master api server 知道它的存在。这涉及到制作镜像，创建 Deployment 和 Service 等 API Resource；由于需要和 master api server 通信，还需要 ServiceAccount 以及相应的 Role</p> <p><strong>主要工作：</strong></p> <ul><li>创建 Dockerfile, 为 Aggregated API Server 制作镜像</li> <li>制作镜像并推入镜像库（或者 local-image-load）</li> <li>集群中创建辅助资源
<ul><li>Namespace：Server 的 Pod 等资源将部署于此</li> <li>ServiceAccount：用于 Aggregated API Server 与集群 Master API Server 交互</li> <li>ServiceAccount 的权限：
<ul><li>get、watch、list 集群内的 namespace</li> <li>get、watch、list 集群内的 mutationwebhookconfiguration、validationwebhookconfiguration</li> <li>system：auth-delegator</li> <li>extension-apiserver-authentication-reader</li></ul></li> <li>Deployment：管理承载 Aggregated API Server 的 Pod</li> <li>Service：在集群内暴露 Aggregated API Server</li> <li>APIService：通知 Master API Server 知道 Aggregated API Server 的存在和联系</li></ul></li></ul> <p><strong>制作此镜像的 Dockerfile:</strong></p> <div class="language-dockerfile extra-class"><pre class="language-dockerfile"><code><span class="token instruction"><span class="token keyword">FROM</span> golang:1.18 <span class="token keyword">as</span> build</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /go/src/cicd-apiserver</span>
<span class="token instruction"><span class="token keyword">COPY</span> . .</span>
<span class="token instruction"><span class="token keyword">RUN</span> CGO_ENABLED=0 GOARCH=amd64 GOOS=linux go build .</span>

<span class="token instruction"><span class="token keyword">FROM</span> alpine:latest</span>
<span class="token instruction"><span class="token keyword">RUN</span> apk --no-cache add ca-certificates</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">build</span></span> /go/src/cicd-apiserver/cicd-apiserver /</span>
<span class="token instruction"><span class="token keyword">ENTRYPOINT</span> [<span class="token string">&quot;/cicd-apiserver&quot;</span>]</span>
</code></pre></div></div></div>  <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/02/13, 06:42:24</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/1cc02c/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">8. 登录与鉴权的实现</div></a> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/1cc02c/" class="prev">8. 登录与鉴权的实现</a></span> <!----></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/470b10/"><div>
            概述
            <!----></div></a> <span class="date">02-10</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/1cc02c/"><div>
            8. 登录与鉴权的实现
            <!----></div></a> <span class="date">02-09</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/c1fc43/"><div>
            7. Http Req 处理过程和 Default Filters
            <!----></div></a> <span class="date">02-09</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2023
    <span>Brook-w | <a href="https://github.com/brook-w/blogs/blob/master/LICENSE" target="_blank">GPL License</a></span> <div><a href="https://beian.miit.gov.cn/" target="_blank">
      京ICP备2020045721号-2
    </a></div></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"></div></div>
  <script src="/assets/js/app.bb52296d.js" defer></script><script src="/assets/js/2.10f4d805.js" defer></script><script src="/assets/js/3.d91ac3a8.js" defer></script><script src="/assets/js/19.03331e5a.js" defer></script>

</body>

</html>